{"ast":null,"code":"import _objectSpread from\"D:/SRC/XAMPP/htdocs/sites/Briefer-v02/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _objectWithoutProperties from\"D:/SRC/XAMPP/htdocs/sites/Briefer-v02/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js\";const _excluded=[\"heading\"];import React,{useState,useEffect,useRef,useImperativeHandle,memo,useCallback}from'react';import ReactQuill from'react-quill';import'react-quill/dist/quill.snow.css';import{convertToHtml}from'../utils/markdown';// Import the markdown utility\nimport{jsonRepair}from'../utils/jsonRepair';// Function to remove citations like [1], [2], [123] from text\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export function removeCitations(text){return text.replace(/\\[\\d+\\]/g,'');}const CardEditor=/*#__PURE__*/React.forwardRef((_ref,ref)=>{let{cards,setCards,showNotification}=_ref;const[isEditingMode,setIsEditingMode]=useState(false);const[currentCard,setCurrentCard]=useState(null);const[hasUnsavedChanges,setHasUnsavedChanges]=useState(false);const[isNewCard,setIsNewCard]=useState(false);const[lastAIRequest,setLastAIRequest]=useState(0);const[aiRequestCooldown]=useState(10000);// 10 seconds\nconst[title,setTitle]=useState('');const[content,setContent]=useState('');const[aiPrompt,setAiPrompt]=useState('');const[promptCounter,setPromptCounter]=useState(0);const[aiStatus,setAiStatus]=useState('• AI Ready');const titleInputRef=useRef(null);const modalRef=useRef(null);const quillRef=useRef(null);const isLoadingContentRef=useRef(false);// Keep a ref to cards to access current state inside closures (like openEditModal)\nconst cardsRef=useRef(cards);useEffect(()=>{cardsRef.current=cards;},[cards]);// Keep a ref to cards to access current state inside closures (like openEditModal)\n/* Removed cardsRef as we now use explicit isNew flag */// Quill modules configuration to match original styling\nconst modules={toolbar:[[{'header':[3,4,5,6,false]}],['bold','italic','underline','strike'],[{'list':'ordered'},{'list':'bullet'}],['link'],['clean']]};const formats=['header','bold','italic','underline','strike','list','bullet','link'];// Helper function for escaping HTML\nconst escapeHtml=text=>{const div=document.createElement('div');div.textContent=text;return div.innerHTML;};// Define closeModal and saveCardChanges BEFORE useEffect hooks\nconst closeModal=useCallback(function(){let force=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!force&&hasUnsavedChanges){if(!window.confirm('You have unsaved changes. Are you sure you want to close without saving?')){return;}}setIsEditingMode(false);setCurrentCard(null);setIsNewCard(false);setHasUnsavedChanges(false);setTitle('');setContent('');setAiPrompt('');setPromptCounter(0);setAiStatus('\\u2022 AI Ready');},[hasUnsavedChanges]);const saveCardChanges=useCallback(()=>{console.log('Saving card changes. isNewCard:',isNewCard,'currentCard:',currentCard);// Validate that at least title or content is provided\nif(!title.trim()&&!content.trim()){showNotification('Please enter a title or content for the card.','warning');return;}// Create new card HTML\nlet newHTML='';if(title.trim()){newHTML+=\"<h2 class=\\\"text-2xl font-semibold mb-4 text-gray-800\\\">\".concat(escapeHtml(title.trim()),\"</h2>\");}if(content.trim()){// Use the HTML content directly from Quill\nnewHTML+=content;}if(isNewCard){console.log('Appending NEW card');// Create a new card\nconst newCard={id:'card-'+Date.now(),content:newHTML};setCards([...cards,newCard]);}else{console.log('Updating EXISTING card',currentCard.id);// Update existing card\nconst updatedCards=cards.map(card=>{if(card.id===currentCard.id){// Remove 'heading' property to avoid duplication (Rendered via Card.js AND content)\n// We are baking the title into the HTML content now.\nconst{heading}=card,rest=_objectWithoutProperties(card,_excluded);return _objectSpread(_objectSpread({},rest),{},{content:newHTML});}return card;});setCards(updatedCards);}// Show success feedback\nconst message=isNewCard?'New card added successfully!':'Card updated successfully!';showNotification(message,'success');// Close modal\ncloseModal(true);},[isNewCard,currentCard,title,content,showNotification,cards,setCards,closeModal]);// Expose methods to parent component\nuseImperativeHandle(ref,()=>({openEditModal:card=>{openEditModal(card);}}),[]);// Setup keyboard shortcuts\nuseEffect(()=>{const handleKeyDown=e=>{if(isEditingMode){if(e.key==='Escape'){e.preventDefault();closeModal();}else if(e.ctrlKey&&e.key==='Enter'){e.preventDefault();saveCardChanges();}}};document.addEventListener('keydown',handleKeyDown);return()=>{document.removeEventListener('keydown',handleKeyDown);};},[isEditingMode,closeModal,saveCardChanges]);// Handle custom event for opening modal\nuseEffect(()=>{const handleOpenEditModal=e=>{openEditModal(e.detail);};window.addEventListener('openEditModal',handleOpenEditModal);return()=>{window.removeEventListener('openEditModal',handleOpenEditModal);};},[]);// Focus title input when modal opens\n// Focus title input when modal opens - REMOVED per user request\n/* \r\n  useEffect(() => {\r\n    if (isEditingMode && titleInputRef.current) {\r\n      setTimeout(() => {\r\n        titleInputRef.current.focus();\r\n      }, 100);\r\n    }\r\n  }, [isEditingMode]);\r\n  */const openEditModal=card=>{console.log('OpenEditModal called with:',card);isLoadingContentRef.current=true;// Prevent onChange from marking as unsaved\nsetCurrentCard(card);setIsEditingMode(true);setHasUnsavedChanges(false);// 1. Check if card explicitly says it is new\nif(card.isNew){console.log('Card has isNew: true flag');setIsNewCard(true);setTitle('');setContent('');// Delay to allow onChange events to settle\nsetTimeout(()=>{isLoadingContentRef.current=false;},100);return;}// 2. Safety check: Does this card ID exist in our current cards list?\nconst existingCardIndex=cardsRef.current.findIndex(c=>c.id===card.id);const idExists=existingCardIndex!==-1;console.log(\"Card ID \".concat(card.id,\" exists in list? \").concat(idExists,\" (index: \").concat(existingCardIndex,\")\"));if(idExists){console.log('Card exists in list -> Treating as EXISTING (isNewCard: false)');setIsNewCard(false);}else{// It doesn't exist in our list, and doesn't have isNew flag.\n// This is the ambiguous case.\n// If content is empty, maybe it's new?\n// But for \"category articles\" duplication bug, we want to err on side of \"Existing\" if possible,\n// but if we treat as existing and it's not in the list, save will do nothing.\n// Let's assume if it came in with content, it's NOT new, even if we can't find ID (maybe stale ID?).\nconsole.log('Card ID not found key logic fallback.');setIsNewCard(false);}// If card has explicit heading/content (e.g., category articles), use it directly\nif(card&&typeof card.heading==='string'&&card.heading.trim()!==''){setTitle(card.heading);setContent(card.content||'');// Delay to allow onChange events to settle\nsetTimeout(()=>{isLoadingContentRef.current=false;},100);return;}// Extract title and content from card HTML\nif(card.content&&card.content.trim()!==''){const parser=new DOMParser();const doc=parser.parseFromString(card.content,'text/html');const titleElement=doc.querySelector('h1, h2, h3, h4, h5, h6');const titleText=titleElement?titleElement.textContent:'';// Remove title element to get content\nif(titleElement){titleElement.remove();}// Get remaining content\nconst contentElements=Array.from(doc.body.children);let contentHTML='';contentElements.forEach(element=>{if(element.classList&&!element.classList.contains('flex')){contentHTML+=element.outerHTML;}});setTitle(titleText);setContent(contentHTML);}else{// Fallback for existing empty cards\nsetTitle('');setContent('');}// Delay to allow onChange events to settle\nsetTimeout(()=>{isLoadingContentRef.current=false;},100);};const handleAiPromptChange=e=>{const value=e.target.value;setAiPrompt(value);setPromptCounter(value.length);// Color coding based on length (matching original behavior)\nif(value.length<10){const counterElement=document.getElementById('promptCounter');if(counterElement){counterElement.className='text-gray-400';}}else if(value.length<=500){const counterElement=document.getElementById('promptCounter');if(counterElement){counterElement.className='text-green-600';}}else{// Trim to maximum length\nconst trimmedValue=value.substring(0,500);setAiPrompt(trimmedValue);setPromptCounter(500);const counterElement=document.getElementById('promptCounter');if(counterElement){counterElement.className='text-red-600';}}};const validatePrompt=prompt=>{// Length validation\nif(prompt.length<10){return{isValid:false,error:'Prompt too short. Minimum 10 characters required.'};}if(prompt.length>500){return{isValid:false,error:'Prompt too long. Maximum 500 characters allowed.'};}// Forbidden phrases\nconst forbiddenPhrases=['измени тему','добавь рекламу','смени направление','change topic','add advertisement','change direction'];const lowerPrompt=prompt.toLowerCase();for(const phrase of forbiddenPhrases){if(lowerPrompt.includes(phrase.toLowerCase())){return{isValid:false,error:\"Forbidden phrase detected: \\\"\".concat(phrase,\"\\\". Please reformulate your request for clarity/structure improvement.\")};}}return{isValid:true};};const sendAIPrompt=async()=>{const validation=validatePrompt(aiPrompt);if(!validation.isValid){showNotification(\"Validation Error: \".concat(validation.error),'error');return;}// Check rate limiting\nconst now=Date.now();if(now-lastAIRequest<aiRequestCooldown){const remainingTime=Math.ceil((aiRequestCooldown-(now-lastAIRequest))/1000);showNotification(\"Please wait \".concat(remainingTime,\" seconds before next AI request.\"),'warning');return;}// Show loading state\nsetAiStatus('• Processing...');const statusElement=document.getElementById('aiStatus');if(statusElement){statusElement.className='ml-2 text-blue-600 text-xs';}try{const response=await fetch('http://localhost:3003/api/ai/improve-content',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:aiPrompt,content:content})});if(!response.ok){const errorData=await response.json();const errorMessage=errorData.details||errorData.error||\"API request failed: \".concat(response.status);throw new Error(errorMessage);}const data=await response.json();const aiResponse=data.content;if(aiResponse.startsWith('ERROR:')){showNotification(aiResponse,'error');}else{// Convert AI-generated content from markdown/plain text to HTML\nconst htmlContent=convertToHtml(aiResponse);setContent(htmlContent);}// Mark as having unsaved changes\nsetHasUnsavedChanges(true);showNotification('AI improvements applied! Review and save changes.','success');setLastAIRequest(now);}catch(error){console.error('AI API Error:',error);showNotification('AI service temporarily unavailable. Please try again later.','error');}finally{setAiStatus('• AI Ready');const statusElement=document.getElementById('aiStatus');if(statusElement){statusElement.className='ml-2 text-green-600 text-xs';}setAiPrompt('');setPromptCounter(0);}};const handleTitleChange=e=>{setTitle(e.target.value);if(!isLoadingContentRef.current){setHasUnsavedChanges(true);}};const handleContentChange=value=>{setContent(value);if(!isLoadingContentRef.current){setHasUnsavedChanges(true);}};// Handle Enter key in AI prompt (matching original behavior)\nconst handleAiPromptKeyDown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendAIPrompt();}};// Memoize the Quill component to prevent unnecessary re-renders\nconst quillModules=React.useMemo(()=>modules,[]);const quillFormats=React.useMemo(()=>formats,[]);return/*#__PURE__*/_jsx(\"div\",{id:\"editModal\",className:\"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-0 hidden\",style:{display:isEditingMode?'flex':'none',zIndex:'var(--z-modal-content)'},ref:modalRef,children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white rounded-none w-full h-full shadow-xl transition-all duration-300 flex flex-col\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 border-b border-gray-200\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-end mb-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-4\",children:[/*#__PURE__*/_jsx(\"button\",{id:\"saveCardEdit\",className:\"text-blue-500 font-semibold text-sm hover:underline focus:outline-none\",onClick:saveCardChanges,tabIndex:-1,children:\"SAVE\"}),/*#__PURE__*/_jsx(\"button\",{id:\"closeModal\",className:\"text-gray-400 hover:text-gray-600 focus:outline-none\",onClick:closeModal,tabIndex:-1,children:/*#__PURE__*/_jsx(\"svg\",{className:\"w-6 h-6\",fill:\"none\",stroke:\"currentColor\",viewBox:\"0 0 24 24\",xmlns:\"http://www.w3.org/2000/svg\",children:/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:\"2\",d:\"M6 18L18 6M6 6l12 12\"})})})]})}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",id:\"cardTitle\",className:\"text-xl font-bold text-gray-800 border-none outline-none focus:outline-none bg-transparent w-full pl-4\",placeholder:\"Enter section title\",value:title,onChange:handleTitleChange,ref:titleInputRef,tabIndex:-1,autoFocus:false})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1 flex flex-col overflow-hidden\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 overflow-y-auto p-4\",children:/*#__PURE__*/_jsx(ReactQuill,{ref:quillRef,theme:\"snow\",placeholder:\"Write your experience...\",value:content,onChange:handleContentChange,modules:quillModules,formats:quillFormats,className:\"h-full quill-focus-white\",tabIndex:-1,style:{border:'none',outline:'none'}})}),/*#__PURE__*/_jsx(\"div\",{className:\"border-t border-gray-200 p-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col items-end\",children:[/*#__PURE__*/_jsx(\"textarea\",{id:\"aiPrompt\",className:\"w-full p-3 rounded-lg outline-none text-gray-600 resize-none transition-colors focus:outline-none\",placeholder:\"Write prompt for AI assistance...\",rows:\"2\",value:aiPrompt,onChange:handleAiPromptChange,onKeyDown:handleAiPromptKeyDown,tabIndex:-1}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 flex items-center justify-between w-full\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs text-gray-400\",children:[/*#__PURE__*/_jsx(\"span\",{id:\"promptCounter\",children:promptCounter}),\"/500 characters\",/*#__PURE__*/_jsx(\"span\",{id:\"aiStatus\",className:\"ml-2 text-green-600 text-xs\",children:aiStatus})]}),/*#__PURE__*/_jsx(\"button\",{id:\"sendPrompt\",className:\"p-2 rounded-full bg-blue-500 text-white shadow-md hover:bg-blue-600 transition-all duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed\",onClick:sendAIPrompt,disabled:aiStatus==='• Processing...',tabIndex:-1,children:/*#__PURE__*/_jsx(\"svg\",{className:\"w-5 h-5\",fill:\"none\",stroke:\"currentColor\",viewBox:\"0 0 24 24\",xmlns:\"http://www.w3.org/2000/svg\",children:/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:\"2\",d:\"M12 19l9 2-9-18-9 18 9-2zm0 0v-8\"})})})]})]})})]})]})});});// Memoize the component to prevent unnecessary re-renders\nexport default/*#__PURE__*/memo(CardEditor);","map":{"version":3,"names":["React","useState","useEffect","useRef","useImperativeHandle","memo","useCallback","ReactQuill","convertToHtml","jsonRepair","jsx","_jsx","jsxs","_jsxs","removeCitations","text","replace","CardEditor","forwardRef","_ref","ref","cards","setCards","showNotification","isEditingMode","setIsEditingMode","currentCard","setCurrentCard","hasUnsavedChanges","setHasUnsavedChanges","isNewCard","setIsNewCard","lastAIRequest","setLastAIRequest","aiRequestCooldown","title","setTitle","content","setContent","aiPrompt","setAiPrompt","promptCounter","setPromptCounter","aiStatus","setAiStatus","titleInputRef","modalRef","quillRef","isLoadingContentRef","cardsRef","current","modules","toolbar","formats","escapeHtml","div","document","createElement","textContent","innerHTML","closeModal","force","arguments","length","undefined","window","confirm","saveCardChanges","console","log","trim","newHTML","concat","newCard","id","Date","now","updatedCards","map","card","heading","rest","_objectWithoutProperties","_excluded","_objectSpread","message","openEditModal","handleKeyDown","e","key","preventDefault","ctrlKey","addEventListener","removeEventListener","handleOpenEditModal","detail","isNew","setTimeout","existingCardIndex","findIndex","c","idExists","parser","DOMParser","doc","parseFromString","titleElement","querySelector","titleText","remove","contentElements","Array","from","body","children","contentHTML","forEach","element","classList","contains","outerHTML","handleAiPromptChange","value","target","counterElement","getElementById","className","trimmedValue","substring","validatePrompt","prompt","isValid","error","forbiddenPhrases","lowerPrompt","toLowerCase","phrase","includes","sendAIPrompt","validation","remainingTime","Math","ceil","statusElement","response","fetch","method","headers","JSON","stringify","ok","errorData","json","errorMessage","details","status","Error","data","aiResponse","startsWith","htmlContent","handleTitleChange","handleContentChange","handleAiPromptKeyDown","shiftKey","quillModules","useMemo","quillFormats","style","display","zIndex","onClick","tabIndex","fill","stroke","viewBox","xmlns","strokeLinecap","strokeLinejoin","strokeWidth","d","type","placeholder","onChange","autoFocus","theme","border","outline","rows","onKeyDown","disabled"],"sources":["D:/SRC/XAMPP/htdocs/sites/Briefer-v02/src/components/CardEditor.js"],"sourcesContent":["import React, { useState, useEffect, useRef, useImperativeHandle, memo, useCallback } from 'react';\r\nimport ReactQuill from 'react-quill';\r\nimport 'react-quill/dist/quill.snow.css';\r\nimport { convertToHtml } from '../utils/markdown'; // Import the markdown utility\r\nimport { jsonRepair } from '../utils/jsonRepair';\r\n\r\n// Function to remove citations like [1], [2], [123] from text\r\nexport function removeCitations(text) {\r\n  return text.replace(/\\[\\d+\\]/g, '');\r\n}\r\n\r\nconst CardEditor = React.forwardRef(({ cards, setCards, showNotification }, ref) => {\r\n  const [isEditingMode, setIsEditingMode] = useState(false);\r\n  const [currentCard, setCurrentCard] = useState(null);\r\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\r\n  const [isNewCard, setIsNewCard] = useState(false);\r\n  const [lastAIRequest, setLastAIRequest] = useState(0);\r\n  const [aiRequestCooldown] = useState(10000); // 10 seconds\r\n  const [title, setTitle] = useState('');\r\n  const [content, setContent] = useState('');\r\n  const [aiPrompt, setAiPrompt] = useState('');\r\n  const [promptCounter, setPromptCounter] = useState(0);\r\n  const [aiStatus, setAiStatus] = useState('• AI Ready');\r\n\r\n  const titleInputRef = useRef(null);\r\n  const modalRef = useRef(null);\r\n  const quillRef = useRef(null);\r\n  const isLoadingContentRef = useRef(false);\r\n\r\n  // Keep a ref to cards to access current state inside closures (like openEditModal)\r\n  const cardsRef = useRef(cards);\r\n  useEffect(() => {\r\n    cardsRef.current = cards;\r\n  }, [cards]);\r\n\r\n  // Keep a ref to cards to access current state inside closures (like openEditModal)\r\n  /* Removed cardsRef as we now use explicit isNew flag */\r\n\r\n\r\n  // Quill modules configuration to match original styling\r\n  const modules = {\r\n    toolbar: [\r\n      [{ 'header': [3, 4, 5, 6, false] }],\r\n      ['bold', 'italic', 'underline', 'strike'],\r\n      [{ 'list': 'ordered' }, { 'list': 'bullet' }],\r\n      ['link'],\r\n      ['clean']\r\n    ],\r\n  };\r\n\r\n  const formats = [\r\n    'header',\r\n    'bold', 'italic', 'underline', 'strike',\r\n    'list', 'bullet',\r\n    'link'\r\n  ];\r\n\r\n  // Helper function for escaping HTML\r\n  const escapeHtml = (text) => {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  };\r\n\r\n  // Define closeModal and saveCardChanges BEFORE useEffect hooks\r\n  const closeModal = useCallback((force = false) => {\r\n    if (!force && hasUnsavedChanges) {\r\n      if (!window.confirm('You have unsaved changes. Are you sure you want to close without saving?')) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    setIsEditingMode(false);\r\n    setCurrentCard(null);\r\n    setIsNewCard(false);\r\n    setHasUnsavedChanges(false);\r\n    setTitle('');\r\n    setContent('');\r\n    setAiPrompt('');\r\n    setPromptCounter(0);\r\n    setAiStatus('\\u2022 AI Ready');\r\n  }, [hasUnsavedChanges]);\r\n\r\n  const saveCardChanges = useCallback(() => {\r\n    console.log('Saving card changes. isNewCard:', isNewCard, 'currentCard:', currentCard);\r\n\r\n    // Validate that at least title or content is provided\r\n    if (!title.trim() && !content.trim()) {\r\n      showNotification('Please enter a title or content for the card.', 'warning');\r\n      return;\r\n    }\r\n\r\n    // Create new card HTML\r\n    let newHTML = '';\r\n\r\n    if (title.trim()) {\r\n      newHTML += `<h2 class=\"text-2xl font-semibold mb-4 text-gray-800\">${escapeHtml(title.trim())}</h2>`;\r\n    }\r\n\r\n    if (content.trim()) {\r\n      // Use the HTML content directly from Quill\r\n      newHTML += content;\r\n    }\r\n\r\n    if (isNewCard) {\r\n      console.log('Appending NEW card');\r\n      // Create a new card\r\n      const newCard = {\r\n        id: 'card-' + Date.now(),\r\n        content: newHTML\r\n      };\r\n      setCards([...cards, newCard]);\r\n    } else {\r\n      console.log('Updating EXISTING card', currentCard.id);\r\n      // Update existing card\r\n      const updatedCards = cards.map(card => {\r\n        if (card.id === currentCard.id) {\r\n          // Remove 'heading' property to avoid duplication (Rendered via Card.js AND content)\r\n          // We are baking the title into the HTML content now.\r\n          const { heading, ...rest } = card;\r\n          return { ...rest, content: newHTML };\r\n        }\r\n        return card;\r\n      });\r\n      setCards(updatedCards);\r\n    }\r\n\r\n    // Show success feedback\r\n    const message = isNewCard ? 'New card added successfully!' : 'Card updated successfully!';\r\n    showNotification(message, 'success');\r\n\r\n    // Close modal\r\n    closeModal(true);\r\n  }, [isNewCard, currentCard, title, content, showNotification, cards, setCards, closeModal]);\r\n\r\n  // Expose methods to parent component\r\n  useImperativeHandle(ref, () => ({\r\n    openEditModal: (card) => {\r\n      openEditModal(card);\r\n    }\r\n  }), []);\r\n\r\n  // Setup keyboard shortcuts\r\n  useEffect(() => {\r\n    const handleKeyDown = (e) => {\r\n      if (isEditingMode) {\r\n        if (e.key === 'Escape') {\r\n          e.preventDefault();\r\n          closeModal();\r\n        } else if (e.ctrlKey && e.key === 'Enter') {\r\n          e.preventDefault();\r\n          saveCardChanges();\r\n        }\r\n      }\r\n    };\r\n\r\n    document.addEventListener('keydown', handleKeyDown);\r\n    return () => {\r\n      document.removeEventListener('keydown', handleKeyDown);\r\n    };\r\n  }, [isEditingMode, closeModal, saveCardChanges]);\r\n\r\n  // Handle custom event for opening modal\r\n  useEffect(() => {\r\n    const handleOpenEditModal = (e) => {\r\n      openEditModal(e.detail);\r\n    };\r\n\r\n    window.addEventListener('openEditModal', handleOpenEditModal);\r\n    return () => {\r\n      window.removeEventListener('openEditModal', handleOpenEditModal);\r\n    };\r\n  }, []);\r\n\r\n  // Focus title input when modal opens\r\n  // Focus title input when modal opens - REMOVED per user request\r\n  /* \r\n  useEffect(() => {\r\n    if (isEditingMode && titleInputRef.current) {\r\n      setTimeout(() => {\r\n        titleInputRef.current.focus();\r\n      }, 100);\r\n    }\r\n  }, [isEditingMode]);\r\n  */\r\n\r\n  const openEditModal = (card) => {\r\n    console.log('OpenEditModal called with:', card);\r\n    isLoadingContentRef.current = true; // Prevent onChange from marking as unsaved\r\n\r\n    setCurrentCard(card);\r\n    setIsEditingMode(true);\r\n    setHasUnsavedChanges(false);\r\n\r\n    // 1. Check if card explicitly says it is new\r\n    if (card.isNew) {\r\n      console.log('Card has isNew: true flag');\r\n      setIsNewCard(true);\r\n      setTitle('');\r\n      setContent('');\r\n      // Delay to allow onChange events to settle\r\n      setTimeout(() => {\r\n        isLoadingContentRef.current = false;\r\n      }, 100);\r\n      return;\r\n    }\r\n\r\n    // 2. Safety check: Does this card ID exist in our current cards list?\r\n    const existingCardIndex = cardsRef.current.findIndex(c => c.id === card.id);\r\n    const idExists = existingCardIndex !== -1;\r\n    console.log(`Card ID ${card.id} exists in list? ${idExists} (index: ${existingCardIndex})`);\r\n\r\n    if (idExists) {\r\n      console.log('Card exists in list -> Treating as EXISTING (isNewCard: false)');\r\n      setIsNewCard(false);\r\n    } else {\r\n      // It doesn't exist in our list, and doesn't have isNew flag.\r\n      // This is the ambiguous case.\r\n      // If content is empty, maybe it's new?\r\n      // But for \"category articles\" duplication bug, we want to err on side of \"Existing\" if possible,\r\n      // but if we treat as existing and it's not in the list, save will do nothing.\r\n\r\n      // Let's assume if it came in with content, it's NOT new, even if we can't find ID (maybe stale ID?).\r\n      console.log('Card ID not found key logic fallback.');\r\n      setIsNewCard(false);\r\n    }\r\n\r\n    // If card has explicit heading/content (e.g., category articles), use it directly\r\n    if (card && typeof card.heading === 'string' && card.heading.trim() !== '') {\r\n      setTitle(card.heading);\r\n      setContent(card.content || '');\r\n      // Delay to allow onChange events to settle\r\n      setTimeout(() => {\r\n        isLoadingContentRef.current = false;\r\n      }, 100);\r\n      return;\r\n    }\r\n\r\n    // Extract title and content from card HTML\r\n    if (card.content && card.content.trim() !== '') {\r\n      const parser = new DOMParser();\r\n      const doc = parser.parseFromString(card.content, 'text/html');\r\n\r\n      const titleElement = doc.querySelector('h1, h2, h3, h4, h5, h6');\r\n      const titleText = titleElement ? titleElement.textContent : '';\r\n\r\n      // Remove title element to get content\r\n      if (titleElement) {\r\n        titleElement.remove();\r\n      }\r\n\r\n      // Get remaining content\r\n      const contentElements = Array.from(doc.body.children);\r\n      let contentHTML = '';\r\n      contentElements.forEach(element => {\r\n        if (element.classList && !element.classList.contains('flex')) {\r\n          contentHTML += element.outerHTML;\r\n        }\r\n      });\r\n\r\n      setTitle(titleText);\r\n      setContent(contentHTML);\r\n    } else {\r\n      // Fallback for existing empty cards\r\n      setTitle('');\r\n      setContent('');\r\n    }\r\n\r\n    // Delay to allow onChange events to settle\r\n    setTimeout(() => {\r\n      isLoadingContentRef.current = false;\r\n    }, 100);\r\n  };\r\n\r\n  const handleAiPromptChange = (e) => {\r\n    const value = e.target.value;\r\n    setAiPrompt(value);\r\n    setPromptCounter(value.length);\r\n\r\n    // Color coding based on length (matching original behavior)\r\n    if (value.length < 10) {\r\n      const counterElement = document.getElementById('promptCounter');\r\n      if (counterElement) {\r\n        counterElement.className = 'text-gray-400';\r\n      }\r\n    } else if (value.length <= 500) {\r\n      const counterElement = document.getElementById('promptCounter');\r\n      if (counterElement) {\r\n        counterElement.className = 'text-green-600';\r\n      }\r\n    } else {\r\n      // Trim to maximum length\r\n      const trimmedValue = value.substring(0, 500);\r\n      setAiPrompt(trimmedValue);\r\n      setPromptCounter(500);\r\n      const counterElement = document.getElementById('promptCounter');\r\n      if (counterElement) {\r\n        counterElement.className = 'text-red-600';\r\n      }\r\n    }\r\n  };\r\n\r\n  const validatePrompt = (prompt) => {\r\n    // Length validation\r\n    if (prompt.length < 10) {\r\n      return { isValid: false, error: 'Prompt too short. Minimum 10 characters required.' };\r\n    }\r\n    if (prompt.length > 500) {\r\n      return { isValid: false, error: 'Prompt too long. Maximum 500 characters allowed.' };\r\n    }\r\n\r\n    // Forbidden phrases\r\n    const forbiddenPhrases = [\r\n      'измени тему',\r\n      'добавь рекламу',\r\n      'смени направление',\r\n      'change topic',\r\n      'add advertisement',\r\n      'change direction'\r\n    ];\r\n\r\n    const lowerPrompt = prompt.toLowerCase();\r\n    for (const phrase of forbiddenPhrases) {\r\n      if (lowerPrompt.includes(phrase.toLowerCase())) {\r\n        return {\r\n          isValid: false,\r\n          error: `Forbidden phrase detected: \"${phrase}\". Please reformulate your request for clarity/structure improvement.`\r\n        };\r\n      }\r\n    }\r\n\r\n    return { isValid: true };\r\n  };\r\n\r\n  const sendAIPrompt = async () => {\r\n    const validation = validatePrompt(aiPrompt);\r\n    if (!validation.isValid) {\r\n      showNotification(`Validation Error: ${validation.error}`, 'error');\r\n      return;\r\n    }\r\n\r\n    // Check rate limiting\r\n    const now = Date.now();\r\n    if (now - lastAIRequest < aiRequestCooldown) {\r\n      const remainingTime = Math.ceil((aiRequestCooldown - (now - lastAIRequest)) / 1000);\r\n      showNotification(`Please wait ${remainingTime} seconds before next AI request.`, 'warning');\r\n      return;\r\n    }\r\n\r\n    // Show loading state\r\n    setAiStatus('• Processing...');\r\n    const statusElement = document.getElementById('aiStatus');\r\n    if (statusElement) {\r\n      statusElement.className = 'ml-2 text-blue-600 text-xs';\r\n    }\r\n\r\n    try {\r\n      const response = await fetch('http://localhost:3003/api/ai/improve-content', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          prompt: aiPrompt,\r\n          content: content\r\n        })\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json();\r\n        const errorMessage = errorData.details || errorData.error || `API request failed: ${response.status}`;\r\n        throw new Error(errorMessage);\r\n      }\r\n\r\n      const data = await response.json();\r\n      const aiResponse = data.content;\r\n\r\n      if (aiResponse.startsWith('ERROR:')) {\r\n        showNotification(aiResponse, 'error');\r\n      } else {\r\n\r\n        // Convert AI-generated content from markdown/plain text to HTML\r\n        const htmlContent = convertToHtml(aiResponse);\r\n        setContent(htmlContent);\r\n      }\r\n\r\n      // Mark as having unsaved changes\r\n      setHasUnsavedChanges(true);\r\n\r\n      showNotification('AI improvements applied! Review and save changes.', 'success');\r\n      setLastAIRequest(now);\r\n    } catch (error) {\r\n      console.error('AI API Error:', error);\r\n      showNotification('AI service temporarily unavailable. Please try again later.', 'error');\r\n    } finally {\r\n      setAiStatus('• AI Ready');\r\n      const statusElement = document.getElementById('aiStatus');\r\n      if (statusElement) {\r\n        statusElement.className = 'ml-2 text-green-600 text-xs';\r\n      }\r\n      setAiPrompt('');\r\n      setPromptCounter(0);\r\n    }\r\n  };\r\n\r\n  const handleTitleChange = (e) => {\r\n    setTitle(e.target.value);\r\n    if (!isLoadingContentRef.current) {\r\n      setHasUnsavedChanges(true);\r\n    }\r\n  };\r\n\r\n  const handleContentChange = (value) => {\r\n    setContent(value);\r\n    if (!isLoadingContentRef.current) {\r\n      setHasUnsavedChanges(true);\r\n    }\r\n  };\r\n\r\n  // Handle Enter key in AI prompt (matching original behavior)\r\n  const handleAiPromptKeyDown = (e) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      sendAIPrompt();\r\n    }\r\n  };\r\n\r\n  // Memoize the Quill component to prevent unnecessary re-renders\r\n  const quillModules = React.useMemo(() => modules, []);\r\n  const quillFormats = React.useMemo(() => formats, []);\r\n\r\n  return (\r\n    <div\r\n      id=\"editModal\"\r\n      className=\"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-0 hidden\"\r\n      style={{ display: isEditingMode ? 'flex' : 'none', zIndex: 'var(--z-modal-content)' }}\r\n      ref={modalRef}\r\n    >\r\n      <div className=\"bg-white rounded-none w-full h-full shadow-xl transition-all duration-300 flex flex-col\">\r\n        <div className=\"p-4 border-b border-gray-200\">\r\n          {/* Buttons moved to top and right-aligned */}\r\n          <div className=\"flex justify-end mb-4\">\r\n            <div className=\"flex items-center space-x-4\">\r\n              <button\r\n                id=\"saveCardEdit\"\r\n                className=\"text-blue-500 font-semibold text-sm hover:underline focus:outline-none\"\r\n                onClick={saveCardChanges}\r\n                tabIndex={-1}\r\n              >\r\n                SAVE\r\n              </button>\r\n              <button\r\n                id=\"closeModal\"\r\n                className=\"text-gray-400 hover:text-gray-600 focus:outline-none\"\r\n                onClick={closeModal}\r\n                tabIndex={-1}\r\n              >\r\n                <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path>\r\n                </svg>\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Title input below buttons */}\r\n          <input\r\n            type=\"text\"\r\n            id=\"cardTitle\"\r\n            className=\"text-xl font-bold text-gray-800 border-none outline-none focus:outline-none bg-transparent w-full pl-4\"\r\n            placeholder=\"Enter section title\"\r\n            value={title}\r\n            onChange={handleTitleChange}\r\n            ref={titleInputRef}\r\n            tabIndex={-1}\r\n            autoFocus={false}\r\n          />\r\n        </div>\r\n\r\n        <div className=\"flex-1 flex flex-col overflow-hidden\">\r\n          <div className=\"flex-1 overflow-y-auto p-4\">\r\n            <ReactQuill\r\n              ref={quillRef}\r\n              theme=\"snow\"\r\n              placeholder=\"Write your experience...\"\r\n              value={content}\r\n              onChange={handleContentChange}\r\n              modules={quillModules}\r\n              formats={quillFormats}\r\n              className=\"h-full quill-focus-white\"\r\n              tabIndex={-1}\r\n              style={{ border: 'none', outline: 'none' }}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"border-t border-gray-200 p-4\">\r\n            <div className=\"flex flex-col items-end\">\r\n              <textarea\r\n                id=\"aiPrompt\"\r\n                className=\"w-full p-3 rounded-lg outline-none text-gray-600 resize-none transition-colors focus:outline-none\"\r\n                placeholder=\"Write prompt for AI assistance...\"\r\n                rows=\"2\"\r\n                value={aiPrompt}\r\n                onChange={handleAiPromptChange}\r\n                onKeyDown={handleAiPromptKeyDown}\r\n                tabIndex={-1}\r\n              />\r\n              <div className=\"mt-2 flex items-center justify-between w-full\">\r\n                <div className=\"text-xs text-gray-400\">\r\n                  <span id=\"promptCounter\">{promptCounter}</span>/500 characters\r\n                  <span id=\"aiStatus\" className=\"ml-2 text-green-600 text-xs\">{aiStatus}</span>\r\n                </div>\r\n                <button\r\n                  id=\"sendPrompt\"\r\n                  className=\"p-2 rounded-full bg-blue-500 text-white shadow-md hover:bg-blue-600 transition-all duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                  onClick={sendAIPrompt}\r\n                  disabled={aiStatus === '• Processing...'}\r\n                  tabIndex={-1}\r\n                >\r\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 19l9 2-9-18-9 18 9-2zm0 0v-8\"></path>\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n\r\n// Memoize the component to prevent unnecessary re-renders\r\nexport default memo(CardEditor);"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}